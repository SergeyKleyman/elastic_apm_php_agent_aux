FROM php:8.1.0-cli
ARG OPBEANS_PHP_AGENT_INSTALL_LOCAL_EXTENSION_BINARY=""
ENV OPBEANS_PHP_AGENT_INSTALL_LOCAL_EXTENSION_BINARY="$OPBEANS_PHP_AGENT_INSTALL_LOCAL_EXTENSION_BINARY"
ARG OPBEANS_PHP_AGENT_INSTALL_LOCAL_SRC=""
ENV OPBEANS_PHP_AGENT_INSTALL_LOCAL_SRC="$OPBEANS_PHP_AGENT_INSTALL_LOCAL_SRC"
ARG OPBEANS_PHP_AGENT_INSTALL_PACKAGE_FROM_URL=""
ENV OPBEANS_PHP_AGENT_INSTALL_PACKAGE_FROM_URL="$OPBEANS_PHP_AGENT_INSTALL_PACKAGE_FROM_URL"
ARG OPBEANS_PHP_AGENT_INSTALL_RELEASE_VERSION=""
ENV OPBEANS_PHP_AGENT_INSTALL_RELEASE_VERSION="$OPBEANS_PHP_AGENT_INSTALL_RELEASE_VERSION"

RUN echo "OPBEANS_PHP_AGENT_INSTALL_LOCAL_EXTENSION_BINARY: $OPBEANS_PHP_AGENT_INSTALL_LOCAL_EXTENSION_BINARY"
RUN OPBEANS_PHP_AGENT_INSTALL_LOCAL_EXTENSION_BINARY=$OPBEANS_PHP_AGENT_INSTALL_LOCAL_EXTENSION_BINARY echo "OPBEANS_PHP_AGENT_INSTALL_LOCAL_EXTENSION_BINARY: $OPBEANS_PHP_AGENT_INSTALL_LOCAL_EXTENSION_BINARY"

# Install extensions with 'pecl'
RUN pecl install apcu-5.1.21
RUN docker-php-ext-enable apcu opcache

# PHP confs
COPY php.ini $PHP_INI_DIR/conf.d/

# Create file cache folder
RUN mkdir -p /tmp/php-file-cache

ADD . /app

RUN /app/install_agent.sh

WORKDIR /app

CMD ["php", "-S", "0.0.0.0:9999"]
